<!DOCTYPE html>
<html>
<head>
  <title>ServerChannel.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../doc-style.css" />
  <script src="../doc-filelist.js"></script>
  <script>
    var relativeDir = "../", thisFile = "lib/ServerChannel.js", defaultSidebar = true;
  </script>
  <script src="../doc-script.js"></script>
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
      <div class="heading h1">
        <a href="#serverchannel">ServerChannel</a>
      </div>
      <div class="heading h2">
        <a href="#global%20scope">Global scope</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.parseoptions">ServerChannel.parseOptions</a>
      </div>
      <div class="heading h2">
        <a href="#serverchannel%20constructor">ServerChannel constructor</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.servernode">ServerChannel.servernode</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.sio">ServerChannel.sio</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.options">ServerChannel.options</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.name">ServerChannel.name</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.syslogger">ServerChannel.sysLogger</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.session">ServerChannel.session</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.registry">ServerChannel.registry</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.admin">ServerChannel.admin</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.player">ServerChannel.player</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.waitingroom">ServerChannel.waitingRoom</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.gamerooms">ServerChannel.gameRooms</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.maxrooms">ServerChannel.maxRooms</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.autoroomno">ServerChannel.autoRoomNo</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.bots">ServerChannel.bots</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.phantoms">ServerChannel.phantoms</a>
      </div>
      <div class="heading h2">
        <a href="#serverchannel%20methods">ServerChannel methods</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.createservers">ServerChannel.createServers</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.listen">ServerChannel.listen</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.creategameroom">ServerChannel.createGameRoom</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.createwaitingroom">ServerChannel.createWaitingRoom</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.destroygameroom">ServerChannel.destroyGameRoom</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.moveplayer">ServerChannel.movePlayer</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.placeplayer">ServerChannel.placePlayer</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.require">ServerChannel.require</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.resolvegamedir">ServerChannel.resolveGameDir</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.connectbot">ServerChannel.connectBot</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.connectphantom">ServerChannel.connectPhantom</a>
      </div>
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel">
  <h1>
    <a href="#serverchannel" name="serverchannel" class="pilcrow">&#182;</a>
    ServerChannel
  </h1>
</div>


<p>Copyright(c) 2014 Stefano Balietti
MIT Licensed</p>
  </div>
  <div class="body"><p>Creates the Player, and Admin Server</p>

<p>Keeps a register of connected players.</p>

<p>Uses the Socket.IO app created in ServerNode.</p>

<p>Gives methods to create and destroy game rooms,
and to move players around them.</p>

<p><a href='http://www.nodegame.org'>http://www.nodegame.org</a></p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="s2">&quot;use strict&quot;</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="global%20scope">
  <h2>
    <a href="#global%20scope" name="global%20scope" class="pilcrow">&#182;</a>
    Global scope
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">ServerChannel</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">AdminServer</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./servers/AdminServer&#39;</span><span class="p">),</span>
    <span class="nx">PlayerServer</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./servers/PlayerServer&#39;</span><span class="p">),</span>
    <span class="nx">GameServer</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./GameServer&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">ChannelRegistry</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./ChannelRegistry&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">Logger</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./Logger&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">J</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;JSUS&#39;</span><span class="p">).</span><span class="nx">JSUS</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">spawn</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;child_process&#39;</span><span class="p">).</span><span class="nx">spawn</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">ngc</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;nodegame-client&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">PlayerList</span> <span class="o">=</span> <span class="nx">ngc</span><span class="p">.</span><span class="nx">PlayerList</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">GameRoom</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./GameRoom&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">WaitingRoom</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./WaitingRoom&#39;</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.parseoptions">
  <h3>
    <a href="#serverchannel.parseoptions" name="serverchannel.parseoptions" class="pilcrow">&#182;</a>
    ServerChannel.parseOptions
  </h3>
</div>

  </div>
  <div class="body"><p>Parses configuration options for player and admin server</p>

<p>Each server (player and admin) needs a separate configuration object.
However servernode <em>addChannel</em> method receive a single object.</p>

<p>The object must have the <em>admin</em> and <em>player</em> properties, as two objects.
All the properties that are the first level in the main configuration object,
and that are not found in <em>admin</em> or <em>player</em> will be inherited.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">options</span>
      <span class="dox_type">object</span>
      <span>Configuration options</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">object</span>
      <span>out Parsed configuration object</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">ServerChannel</span><span class="p">.</span><span class="nx">parseOptions</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">adminOptions</span><span class="p">,</span> <span class="nx">playerOptions</span><span class="p">,</span> <span class="nx">out</span><span class="p">,</span> <span class="nx">tmp</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<p>Options are mixed in.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">adminOptions</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">admin</span><span class="p">;</span>
    <span class="nx">playerOptions</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">player</span><span class="p">;</span>
    <span class="k">delete</span> <span class="nx">options</span><span class="p">.</span><span class="nx">admin</span><span class="p">;</span>
    <span class="k">delete</span> <span class="nx">options</span><span class="p">.</span><span class="nx">player</span><span class="p">;</span>

    <span class="nx">out</span> <span class="o">=</span> <span class="nx">J</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
    <span class="nx">J</span><span class="p">.</span><span class="nx">mixin</span><span class="p">(</span><span class="nx">adminOptions</span><span class="p">,</span> <span class="nx">out</span><span class="p">);</span>
    <span class="nx">tmp</span> <span class="o">=</span> <span class="nx">J</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
    <span class="nx">J</span><span class="p">.</span><span class="nx">mixout</span><span class="p">(</span><span class="nx">playerOptions</span><span class="p">,</span> <span class="nx">out</span><span class="p">);</span>

    <span class="nx">out</span><span class="p">.</span><span class="nx">admin</span> <span class="o">=</span> <span class="nx">adminOptions</span><span class="p">;</span>
    <span class="nx">out</span><span class="p">.</span><span class="nx">player</span> <span class="o">=</span> <span class="nx">playerOptions</span><span class="p">;</span>

    <span class="k">return</span> <span class="nx">out</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel%20constructor">
  <h2>
    <a href="#serverchannel%20constructor" name="serverchannel%20constructor" class="pilcrow">&#182;</a>
    ServerChannel constructor
  </h2>
</div>

  </div>
  <div class="body"><p>Creates an instance of ServerChannel</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">options</span>
      <span class="dox_type">object</span>
      <span>Configuration object</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">servernode</span>
      <span class="dox_type">ServerNode</span>
      <span>The ServerNode instance</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">sio</span>
      <span class="dox_type">object</span>
      <span>The socket.io server</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">function</span> <span class="nx">ServerChannel</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">servernode</span><span class="p">,</span> <span class="nx">sio</span><span class="p">)</span> <span class="p">{</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.servernode">
  <h3>
    <a href="#serverchannel.servernode" name="serverchannel.servernode" class="pilcrow">&#182;</a>
    ServerChannel.servernode
  </h3>
</div>

  </div>
  <div class="body"><p>Reference to the ServerNode</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">servernode</span> <span class="o">=</span> <span class="nx">servernode</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.sio">
  <h3>
    <a href="#serverchannel.sio" name="serverchannel.sio" class="pilcrow">&#182;</a>
    ServerChannel.sio
  </h3>
</div>

  </div>
  <div class="body"><p>Reference to the Socket.IO app of ServerNode</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">sio</span> <span class="o">=</span> <span class="nx">sio</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.options">
  <h3>
    <a href="#serverchannel.options" name="serverchannel.options" class="pilcrow">&#182;</a>
    ServerChannel.options
  </h3>
</div>

  </div>
  <div class="body"><p>Configuration options</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">options</span> <span class="o">=</span> <span class="nx">ServerChannel</span><span class="p">.</span><span class="nx">parseOptions</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.name">
  <h3>
    <a href="#serverchannel.name" name="serverchannel.name" class="pilcrow">&#182;</a>
    ServerChannel.name
  </h3>
</div>

  </div>
  <div class="body"><p>The name of the channel</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.syslogger">
  <h3>
    <a href="#serverchannel.syslogger" name="serverchannel.syslogger" class="pilcrow">&#182;</a>
    ServerChannel.sysLogger
  </h3>
</div>

  </div>
  <div class="body"><p>The logger for the channel</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">sysLogger</span> <span class="o">=</span> <span class="nx">Logger</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;channel&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.session">
  <h3>
    <a href="#serverchannel.session" name="serverchannel.session" class="pilcrow">&#182;</a>
    ServerChannel.session
  </h3>
</div>

  </div>
  <div class="body"><p>Unique session id, shared by both Player and Admin Server</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">session</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="mi">10000000000000000</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.registry">
  <h3>
    <a href="#serverchannel.registry" name="serverchannel.registry" class="pilcrow">&#182;</a>
    ServerChannel.registry
  </h3>
</div>

  </div>
  <div class="body"><p>The registry of all connected clients</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">ChannelRegistry
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">registry</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ChannelRegistry</span><span class="p">({</span>
        <span class="nx">channelName</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span>
    <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.admin">
  <h3>
    <a href="#serverchannel.admin" name="serverchannel.admin" class="pilcrow">&#182;</a>
    ServerChannel.admin
  </h3>
</div>

  </div>
  <div class="body"><p>The admin server</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GameServer</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">AdminServer
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">admin</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.player">
  <h3>
    <a href="#serverchannel.player" name="serverchannel.player" class="pilcrow">&#182;</a>
    ServerChannel.player
  </h3>
</div>

  </div>
  <div class="body"><p>The player server</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GameServer</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">PlayerServer
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">player</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.waitingroom">
  <h3>
    <a href="#serverchannel.waitingroom" name="serverchannel.waitingroom" class="pilcrow">&#182;</a>
    ServerChannel.waitingRoom
  </h3>
</div>

  </div>
  <div class="body"><p>The default game room for the channel.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">ServerChannel.createWaitingRoom
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">waitingRoom</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.gamerooms">
  <h3>
    <a href="#serverchannel.gamerooms" name="serverchannel.gamerooms" class="pilcrow">&#182;</a>
    ServerChannel.gameRooms
  </h3>
</div>

  </div>
  <div class="body"><p>Associative container for all the game rooms in the channel.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">ServerChannel.createGameRoom
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span> <span class="o">=</span> <span class="p">{};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.maxrooms">
  <h3>
    <a href="#serverchannel.maxrooms" name="serverchannel.maxrooms" class="pilcrow">&#182;</a>
    ServerChannel.maxRooms
  </h3>
</div>

  </div>
  <div class="body"><p>The maximum number of game rooms allowed in this channel.
The value -1 means unlimited.</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">maxRooms</span> <span class="o">=</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">maxRooms</span> <span class="o">?</span>
        <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">maxRooms</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.autoroomno">
  <h3>
    <a href="#serverchannel.autoroomno" name="serverchannel.autoroomno" class="pilcrow">&#182;</a>
    ServerChannel.autoRoomNo
  </h3>
</div>

  </div>
  <div class="body"><p>Incremental index used when creating
game rooms with a default name.</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">autoRoomNo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.bots">
  <h3>
    <a href="#serverchannel.bots" name="serverchannel.bots" class="pilcrow">&#182;</a>
    ServerChannel.bots
  </h3>
</div>

  </div>
  <div class="body"><p>node instances of bots inside the channel, indexed by Client ID</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">bots</span> <span class="o">=</span> <span class="p">{};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.phantoms">
  <h3>
    <a href="#serverchannel.phantoms" name="serverchannel.phantoms" class="pilcrow">&#182;</a>
    ServerChannel.phantoms
  </h3>
</div>

  </div>
  <div class="body"><p>Spawn phantomjs processes, indexed by PID</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">phantoms</span> <span class="o">=</span> <span class="p">{};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21">&#182;</a>
</div>
<p>Creating the AdminServer and PlayerServer.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">createServers</span><span class="p">();</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="serverchannel%20methods">
  <h2>
    <a href="#serverchannel%20methods" name="serverchannel%20methods" class="pilcrow">&#182;</a>
    ServerChannel methods
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.createservers">
  <h3>
    <a href="#serverchannel.createservers" name="serverchannel.createservers" class="pilcrow">&#182;</a>
    ServerChannel.createServers
  </h3>
</div>

  </div>
  <div class="body"><p>Creates the AdminServer and the PlayerServer</p>

<p>Creates the configuration objects to pass to the constructor of each server.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GameServer</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">PlayerServer</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">AdminServer
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">ServerChannel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">createServers</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24">&#182;</a>
</div>
<p>Enforce a name.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">options</span><span class="p">.</span><span class="nx">admin</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">admin</span><span class="p">.</span><span class="nx">name</span> <span class="o">||</span> <span class="s1">&#39;[ADMIN_SERVER]&#39;</span><span class="p">;</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">name</span> <span class="o">||</span> <span class="s1">&#39;[PLAYER_SERVER]&#39;</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25">&#182;</a>
</div>
<p>Actually creates the servers.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">admin</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AdminServer</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">admin</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">player</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PlayerServer</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">player</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26">&#182;</a>
</div>
<p>The two servers are aware of each other.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">admin</span><span class="p">.</span><span class="nx">setPartner</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">setPartner</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">admin</span><span class="p">);</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.listen">
  <h3>
    <a href="#serverchannel.listen" name="serverchannel.listen" class="pilcrow">&#182;</a>
    ServerChannel.listen
  </h3>
</div>

  </div>
  <div class="body"><p>Puts the AdminServer and PlayerServer on listen mode</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">Boolean</span>
      <span>TRUE, if both servers are turned on successfully</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">ServerChannel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">listen</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">admin</span><span class="p">.</span><span class="nx">listen</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">listen</span><span class="p">();</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">sysLogger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.creategameroom">
  <h3>
    <a href="#serverchannel.creategameroom" name="serverchannel.creategameroom" class="pilcrow">&#182;</a>
    ServerChannel.createGameRoom
  </h3>
</div>

  </div>
  <div class="body"><p>Creates and returns a new GameRoom object</p>

<p>If conf.name is not given, the next free name in the sequence
'room1', 'room2', ..., 'room999' is automatically chosen and set in
the conf parameter.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">conf</span>
      <span class="dox_type">object</span>
      <span>Config object, acceptable by GameRoom constructor</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">GameRoom</span>
      <span>The new GameRoom</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GameRoom
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">ServerChannel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">createGameRoom</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">conf</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">maxRoomsErr</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">autoRoomNo</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">clients</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">playerIds</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">newRoom</span><span class="p">,</span> <span class="nx">roomGroup</span><span class="p">;</span>
    <span class="nx">conf</span> <span class="o">=</span> <span class="nx">conf</span> <span class="o">||</span> <span class="p">{};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29">&#182;</a>
</div>
<p>Checking if the limit in the number of game rooms has been hit.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">maxRooms</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">J</span><span class="p">.</span><span class="nx">size</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">maxRooms</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">maxRoomsErr</span> <span class="o">=</span> <span class="s1">&#39;Max number of game rooms for &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span>
            <span class="s1">&#39; reached: &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">maxRooms</span><span class="p">;</span>
        <span class="nx">maxRoomsErr</span> <span class="o">+=</span> <span class="s1">&#39; . Cannot create another game room.&#39;</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">sysLogger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">maxRoomsErr</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">clients</span> <span class="o">=</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">clients</span><span class="p">;</span>

    <span class="nx">roomGroup</span> <span class="o">=</span> <span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">group</span> <span class="o">?</span> <span class="s1">&#39;room&#39;</span> <span class="o">:</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">group</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30">&#182;</a>
</div>
<p>Generate default name if none given:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31">&#182;</a>
</div>
<p>Try 'room1', 'room2', ..., 'room999':</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">do</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">autoRoomNo</span><span class="o">++</span><span class="p">;</span>
            <span class="nx">conf</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">roomGroup</span> <span class="o">+</span> <span class="s1">&#39;&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">autoRoomNo</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">while</span> <span class="p">(</span><span class="nx">conf</span><span class="p">.</span><span class="nx">name</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">);</span>
    <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32">&#182;</a>
</div>
<p>Check for name availibility:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">conf</span><span class="p">.</span><span class="nx">name</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;ServerChannel.createGameRoom: Requested room name &#39;&quot;</span> <span class="o">+</span>
                    <span class="nx">conf</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;&#39; already taken.&quot;</span><span class="p">);</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33">&#182;</a>
</div>
<p>Check for parent existence:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">conf</span><span class="p">.</span><span class="nx">parentRoom</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="nx">conf</span><span class="p">.</span><span class="nx">parentRoom</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;ServerChannel.createGameRoom: Nonexistent room &#39;&quot;</span> <span class="o">+</span>
                    <span class="nx">conf</span><span class="p">.</span><span class="nx">parentRoom</span> <span class="o">+</span> <span class="s2">&quot;&#39; requested as parent.&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">channel</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">sysLogger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;ServerChannel.createGameRoom: channel parameter &quot;</span> <span class="o">+</span>
                           <span class="s2">&quot;ignored.&quot;</span><span class="p">,</span> <span class="s1">&#39;warn&#39;</span><span class="p">);</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34">&#182;</a>
</div>
<p>Adding a reference to this channel.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">conf</span><span class="p">.</span><span class="nx">channel</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35">&#182;</a>
</div>
<p>Construct room (the players will be moved into it explicitly):</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">delete</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">clients</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36">&#182;</a>
</div>
<p>Setting group = name if none is defined.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">conf</span><span class="p">.</span><span class="nx">group</span> <span class="o">=</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">group</span> <span class="o">?</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">name</span> <span class="o">:</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">group</span><span class="p">;</span>

    <span class="nx">newRoom</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">GameRoom</span><span class="p">(</span><span class="nx">conf</span><span class="p">);</span>
    <span class="nx">conf</span><span class="p">.</span><span class="nx">clients</span> <span class="o">=</span> <span class="nx">clients</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37">&#182;</a>
</div>
<p>Add to parent:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">conf</span><span class="p">.</span><span class="nx">parentRoom</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">[</span><span class="nx">conf</span><span class="p">.</span><span class="nx">parentRoom</span><span class="p">].</span><span class="nx">children</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">newRoom</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-38" id="section-38">&#182;</a>
</div>
<p>Register room:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">[</span><span class="nx">newRoom</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">newRoom</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-39" id="section-39">&#182;</a>
</div>
<p>Move players into the room:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">clients</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">playerIds</span> <span class="o">=</span> <span class="nx">clients</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">getAllKeys</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="k">in</span> <span class="nx">playerIds</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">playerIds</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">movePlayer</span><span class="p">(</span><span class="nx">playerIds</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">newRoom</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">newRoom</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.createwaitingroom">
  <h3>
    <a href="#serverchannel.createwaitingroom" name="serverchannel.createwaitingroom" class="pilcrow">&#182;</a>
    ServerChannel.createWaitingRoom
  </h3>
</div>

  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">conf</span>
      <span class="dox_type">object</span>
      <span>Config object, acceptable by GameRoom constructor</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">GameRoom</span>
      <span>The waiting room</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GameRoom
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">ServerChannel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">createWaitingRoom</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">conf</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">wRoom</span><span class="p">;</span>
    <span class="nx">conf</span> <span class="o">=</span> <span class="nx">conf</span> <span class="o">||</span> <span class="p">{};</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">waitingRoom</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">sysLogger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Waiting Room for channel &#39;&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span>
                           <span class="s2">&quot;&#39; already existing.&quot;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">channel</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">sysLogger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;ServerChannel.createWaitingRoom: parameter &quot;</span> <span class="o">+</span>
                           <span class="s2">&quot;&#39;channel&#39; ignored&quot;</span><span class="p">,</span> <span class="s1">&#39;warn&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">sysLogger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;ServerChannel.createWaitingRoom: parameter &quot;</span> <span class="o">+</span>
                           <span class="s2">&quot;&#39;name&#39; ignored&quot;</span><span class="p">,</span> <span class="s1">&#39;warn&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">conf</span><span class="p">.</span><span class="nx">group</span> <span class="o">=</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">group</span> <span class="o">||</span> <span class="s2">&quot;waitingRoom&quot;</span><span class="p">;</span>
    <span class="nx">conf</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">name</span> <span class="o">||</span> <span class="s2">&quot;waitingRoom&quot;</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-41" id="section-41">&#182;</a>
</div>
<p>Adding a reference to this channel.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">conf</span><span class="p">.</span><span class="nx">channel</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-42" id="section-42">&#182;</a>
</div>
<p>Construct room (the players will be moved into it explicitly):</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">wRoom</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WaitingRoom</span><span class="p">(</span><span class="nx">conf</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-43" id="section-43">&#182;</a>
</div>
<p>Register room:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">waitingRoom</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">[</span><span class="nx">conf</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">wRoom</span><span class="p">;</span>

    <span class="nx">wRoom</span><span class="p">.</span><span class="nx">setupGame</span><span class="p">();</span>
    <span class="nx">wRoom</span><span class="p">.</span><span class="nx">startGame</span><span class="p">();</span>

    <span class="k">return</span> <span class="nx">wRoom</span><span class="p">;</span>
<span class="p">};</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.destroygameroom">
  <h3>
    <a href="#serverchannel.destroygameroom" name="serverchannel.destroygameroom" class="pilcrow">&#182;</a>
    ServerChannel.destroyGameRoom
  </h3>
</div>

  </div>
  <div class="body"><p>Destroys a GameRoom</p>

<p>The child-rooms of the destroyed room are reparented to the destroyed room's
parent.
The room is only destroyed if it's empty or if a valid substitute room is
given to move the players to.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">roomName</span>
      <span class="dox_type">string</span>
      <span>Name of the room to destroy</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">options</span>
      <span class="dox_type">object</span>
      <span>Optional. Additional parameters.

<ul>
<li>substituteRoomName (string):
Optional. Name of the room to move the players to.
If null, then the room will not be deleted if it has players unless
<code>ignorePlayers</code> is true. Default: null</li>
<li>ignoreRunningGame (boolean):
Optional. Delete the room even if the contained game hasn't finished.
Default: FALSE</li>
<li>ignorePlayers (boolean):
Optional. Delete the room even if there are players inside of it.
Players will be moved to the parent room or the waiting room if there is
no parent. Default: FALSE</li>
</ul></span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">boolean</span>
      <span>Whether the room was destroyed successfully</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GameRoom
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">ServerChannel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">destroyGameRoom</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">roomName</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">roomObj</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">clientObjs</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">parentRoom</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">childName</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">substituteRoomName</span><span class="p">,</span> <span class="nx">ignoreRunningGame</span><span class="p">,</span> <span class="nx">ignorePlayers</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">socket</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-45" id="section-45">&#182;</a>
</div>
<p>Get parameters:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
    <span class="nx">substituteRoomName</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">substituteRoomName</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span>
    <span class="nx">ignoreRunningGame</span> <span class="o">=</span> <span class="o">!!</span><span class="nx">options</span><span class="p">.</span><span class="nx">ignoreRunningGame</span><span class="p">;</span>
    <span class="nx">ignorePlayers</span> <span class="o">=</span> <span class="o">!!</span><span class="nx">options</span><span class="p">.</span><span class="nx">ignorePlayers</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">roomName</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">roomObj</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">[</span><span class="nx">roomName</span><span class="p">];</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-46" id="section-46">&#182;</a>
</div>
<p>Check whether the game in the room is still running:
TODO: test this</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">ignoreRunningGame</span> <span class="o">&amp;&amp;</span>
            <span class="nx">roomObj</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">getStateLevel</span><span class="p">()</span> <span class="o">&lt;</span>
            <span class="nx">ngc</span><span class="p">.</span><span class="nx">constants</span><span class="p">.</span><span class="nx">stateLevels</span><span class="p">.</span><span class="nx">GAMEOVER</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-47" id="section-47">&#182;</a>
</div>
<p>Find out where to move the remaining players:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">clientObjs</span> <span class="o">=</span> <span class="nx">roomObj</span><span class="p">.</span><span class="nx">clients</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">getAllKeyElements</span><span class="p">();</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-48" id="section-48">&#182;</a>
</div>
<p>TODO: Check whether there are any <em>players</em> (non-admins) left</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">J</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">clientObjs</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">substituteRoomName</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">substituteRoomName</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">ignorePlayers</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-49" id="section-49">&#182;</a>
</div>
<p>Move players to parent or waiting room:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">if</span> <span class="p">(</span><span class="nx">roomObj</span><span class="p">.</span><span class="nx">parentRoom</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">substituteRoomName</span> <span class="o">=</span> <span class="nx">roomObj</span><span class="p">.</span><span class="nx">parentRoom</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">waitingRoom</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">substituteRoomName</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">waitingRoom</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;ServerChannel.destroyGameRoom: trying to &#39;</span> <span class="o">+</span>
                        <span class="s1">&#39;destroy a room with players but without parent or &#39;</span> <span class="o">+</span>
                        <span class="s1">&#39;waiting room.&#39;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-50" id="section-50">&#182;</a>
</div>
<p>Move players into substitute room and remove admins:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="k">in</span> <span class="nx">clientObjs</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">clientObjs</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">clientObjs</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">admin</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-51" id="section-51">&#182;</a>
</div>
<p>Move player:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                    <span class="k">this</span><span class="p">.</span><span class="nx">movePlayer</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">substituteRoomName</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-52" id="section-52">&#182;</a>
</div>
<p>Disconnect admin:
TODO: test this</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                    <span class="nx">socket</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">admin</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                    <span class="nx">socket</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">(</span><span class="nx">clientObjs</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">sid</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-53" id="section-53">&#182;</a>
</div>
<p>Remove from parent's list of children:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">parentRoom</span> <span class="o">=</span> <span class="nx">roomObj</span><span class="p">.</span><span class="nx">parentRoom</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">parentRoom</span> <span class="o">&amp;&amp;</span> <span class="nx">parentRoom</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">J</span><span class="p">.</span><span class="nx">removeElement</span><span class="p">(</span><span class="nx">roomName</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">[</span><span class="nx">parentRoom</span><span class="p">].</span><span class="nx">children</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="nx">parentRoom</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-54" id="section-54">&#182;</a>
</div>
<p>Give orphan rooms to their grandparent:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="k">in</span> <span class="nx">roomObj</span><span class="p">.</span><span class="nx">childRooms</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">childName</span> <span class="o">=</span> <span class="nx">roomObj</span><span class="p">.</span><span class="nx">childRooms</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">roomObj</span><span class="p">.</span><span class="nx">childRooms</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="nx">childName</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-55" id="section-55">&#182;</a>
</div>
<p>Tell child:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">[</span><span class="nx">childName</span><span class="p">].</span><span class="nx">parentRoom</span> <span class="o">=</span> <span class="nx">parentRoom</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-56" id="section-56">&#182;</a>
</div>
<p>Tell parent:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">if</span> <span class="p">(</span><span class="nx">parentRoom</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">[</span><span class="nx">parentRoom</span><span class="p">].</span><span class="nx">childRooms</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">childName</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-57" id="section-57">&#182;</a>
</div>
<p>Remove room references.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">[</span><span class="nx">roomName</span><span class="p">];</span>
    <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">rooms</span><span class="p">[</span><span class="nx">roomName</span><span class="p">];</span>

    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.moveplayer">
  <h3>
    <a href="#serverchannel.moveplayer" name="serverchannel.moveplayer" class="pilcrow">&#182;</a>
    ServerChannel.movePlayer
  </h3>
</div>

  </div>
  <div class="body"><p>Moves a player into a different room</p>

<p>Removes player from his old room and inserts him into the given room.
Updates the ChannelRegistry.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">playerId</span>
      <span class="dox_type">string</span>
      <span>Player ID or game alias</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">toRoom</span>
      <span class="dox_type">string</span>
      <span>New room ID (must exist)</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">ServerChannel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">movePlayer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">playerId</span><span class="p">,</span> <span class="nx">toRoom</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">fromRoom</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">playerObj</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">toRoomObj</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">oldPlayerList</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">pConnectMsg</span><span class="p">,</span> <span class="nx">pDisconnectMsg</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">filteredPlayers</span><span class="p">;</span>

    <span class="nx">playerId</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">lookupClient</span><span class="p">(</span><span class="nx">playerId</span><span class="p">);</span>

    <span class="nx">fromRoom</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">getClientRoom</span><span class="p">(</span><span class="nx">playerId</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-59" id="section-59">&#182;</a>
</div>
<p>Check for existence of fromRoom:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">fromRoom</span> <span class="o">||</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">fromRoom</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;ServerChannel.movePlayer: &#39;</span> <span class="o">+</span>
                        <span class="s1">&#39;Player was in invalid room: &quot;&#39;</span> <span class="o">+</span> <span class="nx">fromRoom</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">);</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-60" id="section-60">&#182;</a>
</div>
<p>Check for existence of toRoom:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">toRoom</span> <span class="o">||</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">toRoom</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;ServerChannel.movePlayer: &#39;</span> <span class="o">+</span>
                        <span class="s1">&#39;Unknown toRoom: &quot;&#39;</span> <span class="o">+</span> <span class="nx">toRoom</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">);</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-61" id="section-61">&#182;</a>
</div>
<p>Delete player from old room:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">playerObj</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">[</span><span class="nx">fromRoom</span><span class="p">].</span><span class="nx">clients</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">playerId</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">playerObj</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;ServerChannel.movePlayer: &#39;</span> <span class="o">+</span>
                        <span class="s1">&#39;Player &quot;&#39;</span> <span class="o">+</span> <span class="nx">playerId</span> <span class="o">+</span>
                        <span class="s1">&#39;&quot; not found in room &quot;&#39;</span> <span class="o">+</span> <span class="nx">fromRoom</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">toRoomObj</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">[</span><span class="nx">toRoom</span><span class="p">];</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-62" id="section-62">&#182;</a>
</div>
<p>Add player to new room:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">oldPlayerList</span> <span class="o">=</span> <span class="nx">toRoomObj</span><span class="p">.</span><span class="nx">clients</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">breed</span><span class="p">();</span>
    <span class="nx">toRoomObj</span><span class="p">.</span><span class="nx">clients</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">playerObj</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-63" id="section-63">&#182;</a>
</div>
<p>Update ChannelRegistry:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">moveClient</span><span class="p">(</span><span class="nx">playerId</span><span class="p">,</span> <span class="nx">toRoom</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-64" id="section-64">&#182;</a>
</div>
<p>Send updated PLISTs to all involved players.
It is important that the following code executes <em>after</em> the player has
been registered in the new room.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="nx">pConnectMsg</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">msg</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
        <span class="nx">target</span><span class="o">:</span> <span class="s1">&#39;PCONNECT&#39;</span>
    <span class="p">});</span>

    <span class="nx">pDisconnectMsg</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">msg</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
        <span class="nx">target</span><span class="o">:</span> <span class="s1">&#39;PDISCONNECT&#39;</span>
    <span class="p">});</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">notify</span><span class="p">.</span><span class="nx">onConnect</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-65" id="section-65">&#182;</a>
</div>
<p>Notify all the  players that a new one just connected</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">pConnectMsg</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="nx">playerObj</span><span class="p">.</span><span class="nx">id</span><span class="p">};</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">socketManager</span><span class="p">.</span><span class="nx">broadcast2room</span><span class="p">(</span><span class="nx">pConnectMsg</span><span class="p">,</span> <span class="nx">toRoomObj</span><span class="p">,</span> <span class="nx">playerId</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-66" id="section-66">&#182;</a>
</div>
<p>Send the list of connected players to the new player</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">filteredPlayers</span> <span class="o">=</span> <span class="nx">oldPlayerList</span><span class="p">.</span><span class="nx">fetchSubObj</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">socketManager</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">msg</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
            <span class="nx">target</span><span class="o">:</span> <span class="s1">&#39;SETUP&#39;</span><span class="p">,</span>
            <span class="nx">to</span><span class="o">:</span>     <span class="nx">playerId</span><span class="p">,</span>
            <span class="nx">text</span><span class="o">:</span>   <span class="s1">&#39;plist&#39;</span><span class="p">,</span>
            <span class="nx">reliable</span><span class="o">:</span><span class="mi">500</span><span class="p">,</span>
            <span class="nx">data</span><span class="o">:</span>   <span class="nx">J</span><span class="p">.</span><span class="nx">stringify</span><span class="p">([</span><span class="nx">filteredPlayers</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">])</span>
        <span class="p">}));</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-67" id="section-67">&#182;</a>
</div>
<p>"Disconnect" moving player from old room</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">pDisconnectMsg</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="nx">playerObj</span><span class="p">.</span><span class="nx">id</span><span class="p">};</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">socketManager</span><span class="p">.</span><span class="nx">broadcast2room</span><span class="p">(</span><span class="nx">pDisconnectMsg</span><span class="p">,</span>
                                          <span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">[</span><span class="nx">fromRoom</span><span class="p">],</span> <span class="nx">playerId</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="nx">pConnectMsg</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">playerObj</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">socketManager</span><span class="p">.</span><span class="nx">send2roomAdmins</span><span class="p">(</span><span class="nx">pConnectMsg</span><span class="p">,</span> <span class="nx">toRoomObj</span><span class="p">);</span>
        <span class="nx">pDisconnectMsg</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">playerObj</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">socketManager</span><span class="p">.</span><span class="nx">send2roomAdmins</span><span class="p">(</span><span class="nx">pDisconnectMsg</span><span class="p">,</span> <span class="nx">toRoomObj</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.placeplayer">
  <h3>
    <a href="#serverchannel.placeplayer" name="serverchannel.placeplayer" class="pilcrow">&#182;</a>
    ServerChannel.placePlayer
  </h3>
</div>

  </div>
  <div class="body"><p>Places a player into a room for the first time</p>

<p>Player must not be found in any other room, otherwise
an error is raised.</p>

<p>The method is used to place newly connecting players in their
first room, or reconnecting players in their last room.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">playerObj</span>
      <span class="dox_type">object</span>
      <span class="dox_type">Player</span>
      <span>An object representing a player</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">inRoom</span>
      <span class="dox_type">string</span>
      <span>New room ID (must exist)</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">boolean</span>
      <span>Whether the placement was valid and performed</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">ServerChannel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">placePlayer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">playerObj</span><span class="p">,</span> <span class="nx">inRoom</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">playerId</span><span class="p">,</span> <span class="nx">fromRoomName</span><span class="p">,</span> <span class="nx">roomObj</span><span class="p">,</span> <span class="nx">sameRoom</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">e</span><span class="p">;</span>

    <span class="nx">roomObj</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">[</span><span class="nx">inRoom</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">roomObj</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">e</span> <span class="o">=</span> <span class="s1">&#39;ServerChannel.placePlayer: &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;room not found: &quot;&#39;</span> <span class="o">+</span> <span class="nx">inRoom</span> <span class="o">+</span> <span class="s1">&#39;&quot;.&#39;</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">sysLogger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">playerId</span> <span class="o">=</span> <span class="nx">playerObj</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
    <span class="nx">fromRoomName</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">getClientRoom</span><span class="p">(</span><span class="nx">playerId</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-69" id="section-69">&#182;</a>
</div>
<p>Player must not be found already in any room.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">fromRoomName</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">[</span><span class="nx">fromRoomName</span><span class="p">].</span><span class="nx">clients</span><span class="p">.</span><span class="nx">exist</span><span class="p">(</span><span class="nx">playerId</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">e</span> <span class="o">=</span> <span class="s1">&#39;ServerChannel.placePlayer: &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;player already in room: &quot;&#39;</span> <span class="o">+</span> <span class="nx">fromRoomName</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">sysLogger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-70" id="section-70">&#182;</a>
</div>
<p>Add player to room.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">roomObj</span><span class="p">.</span><span class="nx">clients</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">playerObj</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-71" id="section-71">&#182;</a>
</div>
<p>Adds a new room in the room stack in Channel Registry unless the client
is reconnecting, in which case the new room is the same as the old one.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">moveClient</span><span class="p">(</span><span class="nx">playerId</span><span class="p">,</span> <span class="nx">inRoom</span><span class="p">);</span>

    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.require">
  <h3>
    <a href="#serverchannel.require" name="serverchannel.require" class="pilcrow">&#182;</a>
    ServerChannel.require
  </h3>
</div>

  </div>
  <div class="body"><p>Special require statement to share objects with the required files</p>

<p>Always adds a reference to the current <em>channel</em> amongst the exported
modules.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">path</span>
      <span class="dox_type">string</span>
      <span>The path to the required file</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">exports</span>
      <span class="dox_type">object</span>
      <span>Optional. Object literals with properties shared
  with the required file</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">nocache</span>
      <span class="dox_type">boolean</span>
      <span>If TRUE, deletes the cached path and forces
  re-reading from file system. Default: FALSE</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">mixed</span>
      <span>The required file</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <a href="           node-js-require-cache-possible-to-invalidate
">http://stackoverflow.com/questions/9210542/
</a>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">ServerChannel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">require</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">exports</span><span class="p">,</span> <span class="nx">nocache</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">channel</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">nocache</span><span class="p">)</span> <span class="k">delete</span> <span class="nx">require</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="nx">path</span><span class="p">];</span>
    <span class="k">return</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">channel</span> <span class="o">=</span> <span class="nx">channel</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">exports</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">exports</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">exports</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">require</span><span class="p">(</span><span class="nx">path</span><span class="p">);</span>
    <span class="p">})();</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.resolvegamedir">
  <h3>
    <a href="#serverchannel.resolvegamedir" name="serverchannel.resolvegamedir" class="pilcrow">&#182;</a>
    ServerChannel.resolveGameDir
  </h3>
</div>

  </div>
  <div class="body"><p>Shortcut to <code>Servernode.resolveGameDir</code></p>

<p>Useful when it is not possible to expose the whole servernode object</p>

<p>TODO: servernode should be private here.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">ServerNode.resolveGameDir
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">ServerChannel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">resolveGameDir</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">gameName</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">resolveGameDir</span><span class="p">(</span><span class="nx">gameName</span><span class="p">);</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.connectbot">
  <h3>
    <a href="#serverchannel.connectbot" name="serverchannel.connectbot" class="pilcrow">&#182;</a>
    ServerChannel.connectBot
  </h3>
</div>

  </div>
  <div class="body"><p>Create a bot and put it in a room</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">options</span>
      <span class="dox_type">object</span>
      <span>Bot options with the following fields:

<ul>
<li>clientType (string):
Optional. Client type of the bot. Default: 'bot'</li>
<li>room (GameRoom):
The game room in which to put the bot initially</li>
<li>loadGame (boolean):
Optional. Whether to load a game file. The remaining fields are only
used if this is TRUE. Default: TRUE</li>
<li>botPath (string):
Optional. Relative path to the game file. Default: Value in the
game settings for the given treatment and client type</li>
<li>gameName (string):
Optional. Name of the game. Default: room.gameName</li>
<li>treatmentName (string):
Optional. Name of the treatment. Default: room.treatmentName</li>
</ul></span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">mixinConf</span>
      <span class="dox_type">object</span>
      <span>Optional. Additional options to pass to the node
  instance of the room. Overrides the returned game configuration from the
  require statement.</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">object</span>
      <span>The node instance of the new bot</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">ServerChannel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">connectBot</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">mixinConf</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">that</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">bot</span><span class="p">,</span> <span class="nx">botPath</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">loadGame</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">clientType</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">settings</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">gameName</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">game</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">treatmentName</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">node</span><span class="p">;</span>

    <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-75" id="section-75">&#182;</a>
</div>
<p>Check inputs.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;object&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;ServerChannel.connectBot: &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;options must be object.&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">room</span> <span class="k">instanceof</span> <span class="nx">GameRoom</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;ServerChannel.connectBot: &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;options.room must be GameRoom.&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">clientType</span> <span class="o">&amp;&amp;</span>
        <span class="s1">&#39;string&#39;</span>    <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">clientType</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;ServerChannel.connectBot: &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;options.clientType must be string or undefined.&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">clientType</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">clientType</span> <span class="o">||</span> <span class="s1">&#39;bot&#39;</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">botPath</span> <span class="o">&amp;&amp;</span>
        <span class="s1">&#39;string&#39;</span>    <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">botPath</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;ServerChannel.connectBot: &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;options.botPath must be string or undefined.&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">loadGame</span> <span class="o">&amp;&amp;</span>
        <span class="s1">&#39;boolean&#39;</span>   <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">loadGame</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;ServerChannel.connectBot: &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;options.loadGame must be boolean or undefined.&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">loadGame</span> <span class="o">=</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">loadGame</span> <span class="o">?</span>
        <span class="kc">true</span> <span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">loadGame</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">gameName</span> <span class="o">&amp;&amp;</span>
        <span class="s1">&#39;string&#39;</span>    <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">gameName</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;ServerChannel.connectBot: &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;options.gameName must be string or undefined.&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">treatmentName</span> <span class="o">&amp;&amp;</span>
        <span class="s1">&#39;string&#39;</span>    <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">treatmentName</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;ServerChannel.connectBot: &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;options.treatmentName must be string or undefined.&#39;</span><span class="p">);</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-76" id="section-76">&#182;</a>
</div>
<p>Create the bot.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="nx">node</span> <span class="o">=</span> <span class="nx">ngc</span><span class="p">.</span><span class="nx">getClient</span><span class="p">();</span>

    <span class="nx">node</span><span class="p">.</span><span class="nx">log</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">logger</span> <span class="o">||</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">logger</span> <span class="o">=</span> <span class="nx">Logger</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;clients&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="nx">clientType</span><span class="p">});</span>
        <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">lvl</span><span class="p">)</span> <span class="p">{</span> <span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">lvl</span><span class="p">);</span> <span class="p">};</span>
    <span class="p">})();</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">loadGame</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">gameName</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">gameName</span> <span class="o">||</span> <span class="nx">options</span><span class="p">.</span><span class="nx">room</span><span class="p">.</span><span class="nx">gameName</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">gameName</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;ServerChannel.connectBot: &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;options.gameName or options.room.gameName &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;must exist if options.loadGame is true.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">treatmentName</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">treatmentName</span> <span class="o">||</span> <span class="nx">options</span><span class="p">.</span><span class="nx">room</span><span class="p">.</span><span class="nx">treatmentName</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">treatmentName</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;ServerChannel.connectBot: &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;options.treatmentName or options.room.treatmentName &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;must exist if options.loadGame is true.&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nx">game</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">getGamesInfo</span><span class="p">(</span><span class="nx">gameName</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-77" id="section-77">&#182;</a>
</div>
<p>If not given, look up the path of the given type.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">botPath</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-78" id="section-78">&#182;</a>
</div>
<p>Prepend the path to the game directory.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">botPath</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">resolveGameDir</span><span class="p">(</span><span class="nx">gameName</span><span class="p">)</span> <span class="o">+</span>
                <span class="nx">options</span><span class="p">.</span><span class="nx">botPath</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nx">botPath</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">botPath</span> <span class="o">||</span>
                <span class="nx">game</span><span class="p">.</span><span class="nx">treatments</span><span class="p">[</span><span class="nx">treatmentName</span><span class="p">].</span><span class="nx">gamePaths</span><span class="p">[</span><span class="nx">clientType</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="nx">settings</span> <span class="o">=</span> <span class="nx">game</span><span class="p">.</span><span class="nx">treatments</span><span class="p">[</span><span class="nx">treatmentName</span><span class="p">];</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-79" id="section-79">&#182;</a>
</div>
<p>Require bot.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">bot</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">botPath</span><span class="p">)(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">room</span><span class="p">,</span> <span class="nx">treatmentName</span><span class="p">,</span> <span class="nx">settings</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;object&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">bot</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;ServerChannel.connectBot: botPath &quot;&#39;</span> <span class="o">+</span>
                    <span class="nx">botPath</span> <span class="o">+</span> <span class="s1">&#39;&quot; did not return a valid game object.&#39;</span><span class="p">);</span>
        <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-80" id="section-80">&#182;</a>
</div>
<p>Mixin-in nodeGame options.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">mixinConf</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">J</span><span class="p">.</span><span class="nx">mixin</span><span class="p">(</span><span class="nx">bot</span><span class="p">,</span> <span class="nx">mixinConf</span><span class="p">);</span>
        <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-81" id="section-81">&#182;</a>
</div>
<p>Setup must be called before connect.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">node</span><span class="p">.</span><span class="nx">setup</span><span class="p">(</span><span class="s1">&#39;nodegame&#39;</span><span class="p">,</span> <span class="nx">bot</span><span class="p">);</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-82" id="section-82">&#182;</a>
</div>
<p>This code needs to run as soon as the clientId is generated to avoid
calling GameRoom.setupGame before the node object is stored.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">node</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;PLAYER_CREATED&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">that</span><span class="p">.</span><span class="nx">bots</span><span class="p">[</span><span class="nx">node</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">node</span><span class="p">;</span>
    <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-83" id="section-83">&#182;</a>
</div>
<p>Connect bot to server.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">node</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">setSocketType</span><span class="p">(</span><span class="s1">&#39;SocketDirect&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">socket</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">socketManager</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">direct</span>
    <span class="p">});</span>

    <span class="nx">node</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">startingRoom</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">room</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
        <span class="nx">clientType</span><span class="o">:</span>   <span class="nx">clientType</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">node</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.connectphantom">
  <h3>
    <a href="#serverchannel.connectphantom" name="serverchannel.connectphantom" class="pilcrow">&#182;</a>
    ServerChannel.connectPhantom
  </h3>
</div>

  </div>
  <div class="body"><p>Create a PhantomJS player connected to the server</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">options</span>
      <span class="dox_type">object</span>
      <span>Optional. Connection options with these fields:

<ul>
<li>port (number):
Optional. Port to connect to. Default: this.servernode.port</li>
<li>gameName (string):
Optional. Game to connect to. Uses the channel name by default. If all
games have names different from the channel name, this is invalid.
Default: this.name</li>
<li>filePath (string):
Optional. URL suffix for a relative file path, without leading slash.
A trailing slash is required if this is a directory</li>
<li>queryString (string):
Optional. String of query parameters to append
to the URL. Default: '?clientType=autoplay'</li>
<li>phantomjsArgs (array):
Optional. Array of strings to give PhantomJS as command line arguments</li>
</ul></span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">ChildProcess</span>
      <span>Handle to the PhantomJS process</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">ServerChannel.killAllPhantoms
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">ServerChannel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">connectPhantom</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">port</span><span class="p">,</span> <span class="nx">gameName</span><span class="p">,</span> <span class="nx">filePath</span><span class="p">,</span> <span class="nx">queryString</span><span class="p">,</span> <span class="nx">phantomjsArgs</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">serverdir</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">url</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">phantomjs</span><span class="p">,</span> <span class="nx">phPath</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">logger</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">that</span><span class="p">;</span>

    <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-85" id="section-85">&#182;</a>
</div>
<p>Check inputs.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>

    <span class="nx">port</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">port</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">port</span> <span class="o">&amp;&amp;</span>
        <span class="s1">&#39;number&#39;</span>    <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">port</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;ServerChannel.connectPhantom: &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;port must be number or undefined.&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">port</span> <span class="o">=</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">port</span> <span class="o">?</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">port</span> <span class="o">:</span> <span class="nx">port</span><span class="p">;</span>

    <span class="nx">gameName</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">gameName</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">gameName</span> <span class="o">&amp;&amp;</span>
        <span class="s1">&#39;string&#39;</span>    <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">gameName</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;ServerChannel.connectPhantom: &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;gameName must be string or undefined.&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">gameName</span> <span class="o">=</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">gameName</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">:</span> <span class="nx">gameName</span><span class="p">;</span>

    <span class="nx">filePath</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">filePath</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">filePath</span> <span class="o">&amp;&amp;</span>
        <span class="s1">&#39;string&#39;</span>    <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">filePath</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;ServerChannel.connectPhantom: &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;filePath must be string or undefined.&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">filePath</span> <span class="o">=</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">filePath</span> <span class="o">?</span> <span class="s1">&#39;&#39;</span> <span class="o">:</span> <span class="nx">filePath</span><span class="p">;</span>

    <span class="nx">queryString</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">queryString</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">queryString</span> <span class="o">&amp;&amp;</span>
        <span class="s1">&#39;string&#39;</span>    <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">queryString</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;ServerChannel.connectPhantom: &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;queryString must be string or undefined.&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">queryString</span> <span class="o">=</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">queryString</span> <span class="o">?</span>
        <span class="s1">&#39;?clientType=autoplay&#39;</span> <span class="o">:</span> <span class="nx">queryString</span><span class="p">;</span>

    <span class="nx">phantomjsArgs</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">phantomjsArgs</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">phantomjsArgs</span> <span class="o">&amp;&amp;</span>
        <span class="o">!</span><span class="nx">J</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">phantomjsArgs</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;ServerChannel.connectPhantom: &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;phantomjsArgs must be array or undefined.&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">phantomjsArgs</span> <span class="o">=</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">phantomjsArgs</span> <span class="o">?</span>  <span class="p">[]</span> <span class="o">:</span> <span class="nx">phantomjsArgs</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-86" id="section-86">&#182;</a>
</div>
<p>Launch a phantomjs process with a connection to the server.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-87" id="section-87">&#182;</a>
</div>
<p>Set up the arguments to phantomjs.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">serverdir</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">rootDir</span><span class="p">;</span>
    <span class="nx">url</span> <span class="o">=</span> <span class="s1">&#39;http://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">gameName</span> <span class="o">+</span>
          <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">filePath</span> <span class="o">+</span> <span class="nx">queryString</span><span class="p">;</span>
    <span class="nx">phantomjsArgs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">serverdir</span> <span class="o">+</span> <span class="s1">&#39;/phantomjs/openurl.js&#39;</span><span class="p">);</span>
    <span class="nx">phantomjsArgs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-88" id="section-88">&#182;</a>
</div>
<p>Do not call /phantomjs/bin/phantomjs to avoid double spawn.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">phPath</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">serverdir</span> <span class="o">+</span> <span class="s1">&#39;/node_modules/phantomjs/lib/phantomjs&#39;</span><span class="p">).</span><span class="nx">path</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-89" id="section-89">&#182;</a>
</div>
<p>Spawn.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">phantomjs</span> <span class="o">=</span> <span class="nx">spawn</span><span class="p">(</span><span class="nx">phPath</span><span class="p">,</span> <span class="nx">phantomjsArgs</span><span class="p">);</span>

    <span class="nx">phantomjs</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">setEncoding</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
    <span class="nx">logger</span> <span class="o">=</span> <span class="nx">Logger</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;clients&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;phantomjs&#39;</span><span class="p">});</span>

    <span class="nx">phantomjs</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">phantomjs</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;exit&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-90" id="section-90">&#182;</a>
</div>
<p>Wait few ms for error to be printed.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;PhantomJS (PID &#39;</span> <span class="o">+</span> <span class="nx">phantomjs</span><span class="p">.</span><span class="nx">pid</span> <span class="o">+</span> <span class="s1">&#39;) exited&#39;</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">code</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">msg</span> <span class="o">=</span> <span class="s1">&#39;PhantomJS received non-zero exit code: &#39;</span> <span class="o">+</span> <span class="nx">arguments</span><span class="p">;</span>
                <span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">delete</span> <span class="nx">that</span><span class="p">.</span><span class="nx">phantoms</span><span class="p">[</span><span class="nx">phantomjs</span><span class="p">.</span><span class="nx">pid</span><span class="p">];</span>
        <span class="p">},</span> <span class="mi">20</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">phantomjs</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Error executing phantom at&#39;</span><span class="p">,</span> <span class="nx">phPath</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
    <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-91" id="section-91">&#182;</a>
</div>
<p>Add to the global collection.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">phantoms</span><span class="p">[</span><span class="nx">phantomjs</span><span class="p">.</span><span class="nx">pid</span><span class="p">]</span> <span class="o">=</span> <span class="nx">phantomjs</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">phantomjs</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-92" id="section-92">&#182;</a>
</div>
<p>Maybe we do not need this api.
/**
 * ### ServerChannel.killPhantom
 *
 * Sends a SIGHUP signal to all active PhantomJS processes
 *
 * @see ServerChannel.connectPhantom
 */
ServerChannel.prototype.killAllPhantoms = function() {
    var phantom;
    for (phantom in this.phantoms) {
        if (this.phantoms.hasOwnProperty(phantom)) {
            console.log('killing ', phantom);
            process.kill(phantom, 'SIGHUP');
        }
    }
};</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-93" id="section-93">&#182;</a>
</div>
<p>TODO: finish this method. Should destroy all game rooms. clear all players?,
      keep the waiting room</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="nx">ServerChannel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">reboot</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">level</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">that</span><span class="p">,</span> <span class="nx">roomName</span><span class="p">,</span> <span class="nx">waitingLogicId</span><span class="p">;</span>
    <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="nx">waitingLogicId</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">waitingRoom</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-94" id="section-94">&#182;</a>
</div>
<p>Remove clients from registry, game rooms and disconnect them.
   this.registry.clients.each(function(c) {
       if (c.id !== waitingLogicId) {
           if (c.admin) {</p>


<div class="highlight"><pre><code>           <span class="c1">// This is correct but too much...</span>
           <span class="c1">//that.admin.socket.clients[c.id].disconnect(c.sid);</span>


           <span class="k">delete</span> <span class="nx">that</span><span class="p">.</span><span class="nx">admin</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="nx">c</span><span class="p">.</span><span class="nx">id</span><span class="p">].</span><span class="nx">clients</span><span class="p">[</span><span class="nx">c</span><span class="p">.</span><span class="nx">sid</span><span class="p">];</span>
       <span class="p">}</span>
       <span class="k">else</span> <span class="p">{</span>
           <span class="c1">// This is correct but too much...</span>
           <span class="c1">//that.player.socket.clients[c.id].disconnect(c.sid);</span>

           <span class="nx">that</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="nx">c</span><span class="p">.</span><span class="nx">id</span><span class="p">].</span><span class="nx">sio</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span>
                 <span class="nx">sockets</span><span class="p">[</span><span class="nx">c</span><span class="p">.</span><span class="nx">sid</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">)].</span><span class="nx">disconnect</span><span class="p">();</span>
       <span class="p">}</span>
   <span class="p">}</span>
</code></pre></div>



<p>});</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-95" id="section-95">&#182;</a>
</div>
<p>Remove clients from registry, game rooms and disconnect them.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">clients</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">id</span> <span class="o">!==</span> <span class="nx">waitingLogicId</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">that</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">removeClient</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>


    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">roomName</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-96" id="section-96">&#182;</a>
</div>
<p>Destroy empty game rooms.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">for</span> <span class="p">(</span><span class="nx">roomName</span> <span class="k">in</span> <span class="nx">that</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">roomName</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">roomName</span> <span class="o">!==</span> <span class="nx">that</span><span class="p">.</span><span class="nx">waitingRoom</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">that</span><span class="p">.</span><span class="nx">destroyGameRoom</span><span class="p">(</span><span class="nx">roomName</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">},</span> <span class="mi">500</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-97" id="section-97">&#182;</a>
</div>
<p>Create a brand new Registry.
this.registry = new ChannelRegistry({ name: this.name });</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">return</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>

  </div>
</body>
</html>
